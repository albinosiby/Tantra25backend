<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>View Participants - Premium Admin</title>
<link rel="stylesheet" href="/static/css/admin.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="container floating">
    <div class="header">
      <div class="brand">
        <div class="logo pulse"><i class="fas fa-users"></i></div>
        <div>
          <h1>Tantra Admin</h1>
          <div class="small">Manage registered participants</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:12px;">
        <button id="vpFilterToggle" class="btn btn-ghost" aria-expanded="false" title="Show department filters"><i class="fas fa-filter"></i></button>
        <div class="controls">
          <a href="/" class="btn btn-ghost"><i class="fas fa-arrow-left"></i> Dashboard</a>
          <a href="/add_event" class="btn btn-primary"><i class="fas fa-plus"></i> Add Event</a>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header" style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
        <div>
          <h2 style="margin:0">Participants</h2>
          <div class="small">Showing {% if participants %}{{ participants|length }}{% else %}0{% endif %} participants{% if selected_dept_id %} â€” filtered by department{% endif %}</div>
        </div>

        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
          <form method="GET" class="form-row" style="margin:0;">
            <div class="form-group" style="min-width:220px;">
              <label class="sr-only">Department</label>
              <select name="dept_id" id="deptSelect" onchange="this.form.submit()">
                <option value="">All Departments</option>
                {% for id, name in departments %}
                  <option value="{{ id }}" {% if selected_dept_id == id %}selected{% endif %}>{{ name }}</option>
                {% endfor %}
              </select>
            </div>
          </form>

          {% if events_for_select %}
          <form method="GET" id="eventFilterForm" style="margin:0;">
            <input type="hidden" name="dept_id" value="{{ selected_dept_id }}" />
            <div class="form-group" style="min-width:220px;">
              <label class="sr-only">Event</label>
              <select name="event_id" onchange="document.getElementById('eventFilterForm').submit()">
                <option value="">All Events</option>
                {% for eid, ename in events_for_select %}
                  <option value="{{ ename }}" {% if selected_event_id == ename %}selected{% endif %}>{{ ename }}</option>
                {% endfor %}
              </select>
            </div>
          </form>
          {% endif %}

          <div style="display:flex;align-items:center;gap:8px;">
            <input class="search" id="participantSearch" placeholder="Search name, email, college..." />
            {% if participants %}
              <button class="btn btn-ghost" id="copyBtn"><i class="fas fa-copy"></i></button>
            {% endif %}
            <a href="/export_participants?dept_id={{ selected_dept_id }}&event_id={{ selected_event_id }}&format=xlsx" class="btn btn-success"><i class="fas fa-file-excel"></i></a>
            <a href="/export_participants?dept_id={{ selected_dept_id }}&event_id={{ selected_event_id }}&format=pdf" class="btn btn-primary"><i class="fas fa-file-pdf"></i></a>
          </div>
        </div>
      </div>

      {% if participants %}
      <div class="table-wrap" style="margin-top:18px;">
  <table id="participantsTable" class="striped hoverable responsive-table">
          <thead>
            <tr>
              <th><i class="fas fa-user"></i> Name</th>
              <th><i class="fas fa-envelope"></i> Email</th>
              <th><i class="fas fa-phone"></i> Phone</th>
              <th><i class="fas fa-university"></i> College</th>
              <th><i class="fas fa-code-branch"></i> Branch</th>
              <th><i class="fas fa-graduation-cap"></i> Year</th>
              <th><i class="fas fa-calendar-check"></i> Event</th>
              <th><i class="fas fa-receipt"></i> Transaction ID</th>
            </tr>
          </thead>
          <tbody>
          {% for p in participants %}
          <tr>
            <td>{{ p['name'] }}</td>
            <td>{{ p['email'] }}</td>
            <td>{{ p['phone'] }}</td>
            <td>{{ p['college'] }}</td>
            <td>{{ p['branch'] }}</td>
            <td>{{ p['year'] }}</td>
            <td><span class="badge small">{{ p['event_name'] }}</span></td>
            <td><code>{{ p['transaction_id'] }}</code></td>
          </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="no-data" style="margin-top:18px;">
        <i class="fas fa-users-slash" style="font-size: 48px; margin-bottom: 16px; color: var(--muted);"></i>
        <p>No participants match your filters.</p>
      </div>
      {% endif %}

      <div style="margin-top:18px;display:flex;justify-content:space-between;align-items:center;">
        <a href="/" class="back-link"><i class="fas fa-arrow-left"></i> Back to Admin Panel</a>
        <div class="small muted">Tip: use the search box to quickly filter participants</div>
      </div>
    </div>
  </div>

  <script>
    // Enhanced client-side filtering
    const search = document.getElementById('participantSearch');
    if (search) {
      search.addEventListener('input', function(){
        const q = this.value.toLowerCase();
        let visibleCount = 0;
        
        document.querySelectorAll('#participantsTable tbody tr').forEach(tr => {
          const text = tr.innerText.toLowerCase();
          const isVisible = text.includes(q);
          tr.style.display = isVisible ? '' : 'none';
          if (isVisible) visibleCount++;
        });
        
        // Update results count in search placeholder
        if (q.length > 0) {
          search.setAttribute('data-results', `${visibleCount} results`);
        } else {
          search.removeAttribute('data-results');
        }
      });
    }
    
    // Enhanced copy button with feedback
    const copyBtn = document.getElementById('copyBtn');
    if (copyBtn) {
      copyBtn.addEventListener('click', function(e){
        e.preventDefault();
        
        // Add loading state
        const originalText = this.innerHTML;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Copying...';
        this.disabled = true;
        
        let txt = '';
        const headers = Array.from(document.querySelectorAll('#participantsTable thead th'))
          .map(th => th.innerText.replace(/[^a-zA-Z0-9 ]/g, ''))
          .join('\t');
        txt += headers + '\n';
        
        document.querySelectorAll('#participantsTable tbody tr').forEach(tr => { 
          if (tr.style.display !== 'none') {
            txt += Array.from(tr.cells).map(td => td.innerText).join('\t') + '\n'; 
          }
        });
        
        navigator.clipboard.writeText(txt).then(() => { 
          this.innerHTML = '<i class="fas fa-check"></i> Copied!';
          setTimeout(() => {
            this.innerHTML = originalText;
            this.disabled = false;
          }, 2000);
        }).catch(() => { 
          this.innerHTML = '<i class="fas fa-times"></i> Failed';
          setTimeout(() => {
            this.innerHTML = originalText;
            this.disabled = false;
          }, 2000);
        });
      });
    }
  </script>
  <script>
    // Add responsive table labels on this page as well
    function addResponsiveTableLabelsLocal(){
      const tables = Array.from(document.querySelectorAll('table.responsive-table'));
      tables.forEach(table => {
        const ths = Array.from(table.querySelectorAll('thead th'));
        const headers = ths.length ? ths.map(th => th.innerText.trim()) : [];
        table.querySelectorAll('tbody tr').forEach(tr => {
          Array.from(tr.children).forEach((td, idx) => td.setAttribute('data-label', headers[idx] || ''));
        });
      });
    }
    window.addEventListener('resize', addResponsiveTableLabelsLocal);
    addResponsiveTableLabelsLocal();
  </script>
</body>
</html>